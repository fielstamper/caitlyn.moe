<div id="lastfm-grid"></div>

<script>
	import type { AudioscrobblerTrack } from "../types";
	import { LASTFM_KEY, LASTFM_USER } from "../constants";

	function truncate(str: string, maxLength: number): string {
		if (str.length <= maxLength) return str;
		return str.slice(0, maxLength) + "...";
	}

	function makeDisplayFromTrack(
		track: AudioscrobblerTrack,
	): HTMLAnchorElement {
		const container = document.createElement("a");
		const art = document.createElement("img");
		const title = document.createElement("p");
		const artist = document.createElement("footer");

		container.href = track.url;
		art.src = track.image[2]["#text"];
		title.textContent = truncate(track.name, 27);
		artist.textContent = truncate(track.artist.name, 15);

		container.append(art, title, artist);
		return container;
	}

	document.addEventListener("astro:page-load", () => {
		fetch(
			`https://ws.audioscrobbler.com/2.0/?method=user.getrecenttracks&user=${LASTFM_USER}&api_key=${LASTFM_KEY}&extended=1&format=json&limit=5`,
		)
			.then((response) => response.json())
			.then((jsonData) => {
				const lastfmGrid = document.getElementById("lastfm-grid")!;
				const tracks: AudioscrobblerTrack[] =
					jsonData.recenttracks.track;
				tracks
					.map(makeDisplayFromTrack)
					.forEach((track) => lastfmGrid.append(track));
			});
	});
</script>

<style>
	div {
		display: flex;
		justify-content: space-between;
		text-align: center;
		overflow-x: scroll;
		gap: 1rem;
	}
	div > :global(a) {
		display: flex;
		flex-direction: column;
		gap: 4px;
		text-decoration: none;
		align-items: center;
		width: 7.813rem;
	}
	div :global(img) {
		width: 7.813rem;
		height: 7.813rem;
		border-radius: 8px;
	}
	div :global(p) {
		color: var(--foreground);
	}
	div :global(footer) {
		color: var(--background-text);
		font-size: 0.8rem;
	}
</style>
