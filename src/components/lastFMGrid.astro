---
import ScrollingGrid from "@components/scrollingGrid.astro";
---

<ScrollingGrid id="lastfm-grid" />

<script>
	import type { AudioscrobblerTrack } from "../types";
	import { LASTFM_KEY, LASTFM_USER } from "../constants";

	function truncate(str: string, maxLength: number): string {
		if (str.length <= maxLength) return str;
		return str.slice(0, maxLength) + "...";
	}

	function makeDisplayFromTrack(
		track: AudioscrobblerTrack,
	): HTMLAnchorElement {
		const container = document.createElement("a");
		const art = document.createElement("img");
		const title = document.createElement("p");
		const artist = document.createElement("footer");

		container.href = track.url;
		art.src = track.image[2]["#text"];
		title.textContent = truncate(track.name, 27);
		artist.textContent = truncate(track.artist.name, 15);

		container.append(art, title, artist);
		return container;
	}

	document.addEventListener("astro:page-load", () =>
		fetch(
			`https://ws.audioscrobbler.com/2.0/?method=user.getrecenttracks&user=${LASTFM_USER}&api_key=${LASTFM_KEY}&extended=1&format=json&limit=5`,
		)
			.then((response) => response.json())
			.then((jsonData) => {
				const lastfmGrid = document.getElementById("lastfm-grid")!;
				const tracks: AudioscrobblerTrack[] =
					jsonData.recenttracks.track;
				tracks
					.map(makeDisplayFromTrack)
					.forEach((track) => lastfmGrid.append(track));
			}),
	);
</script>
